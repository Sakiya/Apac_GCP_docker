version: '3.8'

services:
  # ==========================================
  # 1. Nginx 反向代理服務 (入口)
  # ==========================================
  nginx:
    image: nginx:alpine
    container_name: oat_nginx
    restart: always # [自動啟動] VM 重開機後自動執行
    # 對外開放 Port 80
    ports:
      - "80:80"
    volumes:
      # 掛載設定檔
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
      # 掛載 Log 資料夾 (資安稽核用)
      - ./logs/nginx:/var/log/nginx
    depends_on:
      - web
    networks:
      - oat-network

  # ==========================================
  # 2. Web 應用程式 (Apache + PHP 8.1 + Yii)
  # ==========================================
  web:
    build: .
    container_name: oat_web
    restart: always # [自動啟動] VM 重開機後自動執行
    # 不直接對外開放 Port，只允許同一網絡內的 Nginx 訪問
    expose:
      - "80"
    volumes:
      # 掛載專案程式碼
      - .:/var/www/html
      # 掛載 Log 資料夾 (資安稽核用)
      - ./logs/apache:/var/log/apache2
      # [持久化] 使用者上傳檔案掛載
      - ./uploads:/var/www/html/www/images/upload
    # 環境變數 (從 .env 檔案讀取)
    environment:
      - DB_HOST=${DB_HOST}
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - YII_DEBUG=${YII_DEBUG}
      - YII_TRACE_LEVEL=${YII_TRACE_LEVEL}
      - GII_PASSWORD=${GII_PASSWORD}
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
    depends_on:
      - db
    networks:
      - oat-network

  # ==========================================
  # 3. 資料庫服務 (MariaDB 10.11)
  # ==========================================
  db:
    # 使用 MariaDB LTS 版本，替代舊版 MySQL
    image: mariadb:10.11
    container_name: oat_db
    restart: always # [自動啟動] VM 重開機後自動執行
    # 對外映射 Port 3307 (避免與本機 3306 衝突)
    ports:
      - "3307:3306"
    # 啟用 General Log 以及 Error Log 記錄到檔案
    command: --log-error=/var/log/mysql/error.log --general-log=1 --general-log-file=/var/log/mysql/general.log
    # 資料庫初始化設定
    environment:
      - MYSQL_DATABASE=${DB_NAME}
      - MYSQL_USER=${DB_USER}
      - MYSQL_PASSWORD=${DB_PASSWORD}
      - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD}
    volumes:
      # 資料庫檔案持久化 (Docker Volume)
      - db_data:/var/lib/mysql
      # 初始化 SQL 腳本 (容器首次啟動時執行)
      - ./juso1326_ota.sql:/docker-entrypoint-initdb.d/init.sql
      # 掛載 Log 資料夾 (資安稽核用)
      - ./logs/mysql:/var/log/mysql
    networks:
      - oat-network

# ==========================================
# 網路與卷定義
# ==========================================
networks:
  oat-network:
    driver: bridge

volumes:
  db_data:

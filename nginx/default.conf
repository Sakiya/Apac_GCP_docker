server {
    # 監聽 Port 80 (HTTP)
    listen 80;

    # [設定網域] 這裡設定您的網址
    # 目前設定：正式機網域 (registration.onearttaipei.com) 以及 本地測試 (localhost)
    # 如果有多個網域，用空白分隔即可
    server_name registration.onearttaipei.com localhost;
    
    # [資安] 隱藏 Nginx 版本資訊，防止駭客針對特定版本攻擊
    server_tokens off;

    # [資安] 安全性標頭 (Security Headers)
    # 防止網站被嵌入 iframe (避免點擊劫持)
    add_header X-Frame-Options "SAMEORIGIN" always;
    # 啟用瀏覽器 XSS 防護
    add_header X-XSS-Protection "1; mode=block" always;
    # 防止瀏覽器猜測檔案類型
    add_header X-Content-Type-Options "nosniff" always;
    # 控制 Referrer 資訊的傳送策略
    add_header Referrer-Policy "no-referrer-when-downgrade" always;

    # [資安] Content Security Policy (CSP) 內容安全策略
    # 這是防止 XSS 最強的防線，限制瀏覽器只能載入我們允許的來源
    # 允許來源: 自身網域, YouTube, Google (Fonts/Maps), Microsoft, 以及部分內聯腳本
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' *.youtube.com *.ytimg.com *.googleapis.com *.google.com *.microsoft.com *.azure.com *.windows.net; style-src 'self' 'unsafe-inline' *.googleapis.com *.google.com *.microsoft.com; img-src 'self' data: *.youtube.com *.ytimg.com *.google.com *.googleapis.com *.gstatic.com *.microsoft.com; font-src 'self' data: *.gstatic.com *.googleapis.com; frame-src 'self' *.youtube.com *.google.com *.microsoft.com; connect-src 'self' *.google.com *.googleapis.com;" always;


    # [SSL] 針對 Let's Encrypt SSL 憑證驗證的配置 (未來申請憑證用)
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # [反向代理] 將所有流量轉發給後端的 Apache 容器
    location / {
        # 轉發到 docker-compose 中名為 'web' 的服務，Port 80
        proxy_pass http://oat_web:80;
        
        # 傳遞真實的使用者 IP 資訊給後端，否則後端看到的 IP 都會是 Docker 內網 IP
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # [逾時設定] 避免後台執行長時間報表運算時斷線 (單位：秒)
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }
}

# [SSL] HTTPS 服務 (Cloudflare Full Strict)
server {
    listen 443 ssl http2;
    server_name registration.onearttaipei.com localhost;

    # SSL 憑證路徑 (對應到 docker-compose.yml 掛載的 volume)
    ssl_certificate /etc/nginx/certs/server.crt;
    ssl_certificate_key /etc/nginx/certs/server.key;

    # SSL 優化設定
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    
    server_tokens off;

    # 安全性標頭 (與 HTTP 相同)
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' *.youtube.com *.ytimg.com *.googleapis.com *.google.com *.microsoft.com *.azure.com *.windows.net; style-src 'self' 'unsafe-inline' *.googleapis.com *.google.com *.microsoft.com; img-src 'self' data: *.youtube.com *.ytimg.com *.google.com *.googleapis.com *.gstatic.com *.microsoft.com; font-src 'self' data: *.gstatic.com *.googleapis.com; frame-src 'self' *.youtube.com *.google.com *.microsoft.com; connect-src 'self' *.google.com *.googleapis.com;" always;

    location / {
        proxy_pass http://oat_web:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }
}

# Portainer 監控後台 (Monitor)
server {
    listen 80;
    server_name monitor.onearttaipei.com;

    # 隱藏 Nginx 版本資訊
    server_tokens off;

    location / {
        proxy_pass http://portainer:9000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket 支援 (Portainer Console 必備)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
